{"ast":null,"code":"import _regeneratorRuntime from\"/home/utoker/Projects/utcode/packages/local-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/utoker/Projects/utcode/packages/local-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import axios from'axios';import localforage from'localforage';var fileCache=localforage.createInstance({name:'filecache'});export var fetchPlugin=function fetchPlugin(inputCode){return{name:'fetch-plugin',setup:function setup(build){build.onLoad({filter:/(^index\\.js)/},function(){return{loader:'jsx',contents:inputCode};});build.onLoad({filter:/.*/},/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(args){var cachedResult;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return fileCache.getItem(args.path);case 2:cachedResult=_context.sent;if(!cachedResult){_context.next=5;break;}return _context.abrupt(\"return\",cachedResult);case 5:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}());build.onLoad({filter:/.css$/},/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(args){var _yield$axios$get,data,request,escaped,contents,result;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return axios.get(args.path);case 2:_yield$axios$get=_context2.sent;data=_yield$axios$get.data;request=_yield$axios$get.request;escaped=data.replace(/\\n/g,'').replace(/\"/g,'\\\\\"').replace(/'/g,\"\\\\'\");contents=\"\\n              const style = document.createElement('style');\\n              style.innerText='\".concat(escaped,\"';\\n              document.head.appendChild(style)\");result={loader:'jsx',contents:contents,resolveDir:new URL('./',request.responseURL).pathname};_context2.next=10;return fileCache.setItem(args.path,result);case 10:return _context2.abrupt(\"return\",result);case 11:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x2){return _ref2.apply(this,arguments);};}());build.onLoad({filter:/.*/},/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(args){var _yield$axios$get2,data,request,result;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return axios.get(args.path);case 2:_yield$axios$get2=_context3.sent;data=_yield$axios$get2.data;request=_yield$axios$get2.request;result={loader:'jsx',contents:data,resolveDir:new URL('./',request.responseURL).pathname};_context3.next=8;return fileCache.setItem(args.path,result);case 8:return _context3.abrupt(\"return\",result);case 9:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x3){return _ref3.apply(this,arguments);};}());}};};","map":{"version":3,"sources":["/home/utoker/Projects/utcode/packages/local-client/src/bundler/plugins/fetch-plugin.ts"],"names":["axios","localforage","fileCache","createInstance","name","fetchPlugin","inputCode","setup","build","onLoad","filter","loader","contents","args","getItem","path","cachedResult","get","data","request","escaped","replace","result","resolveDir","URL","responseURL","pathname","setItem"],"mappings":"+UAAA,MAAOA,CAAAA,KAAP,KAAkB,OAAlB,CAEA,MAAOC,CAAAA,WAAP,KAAwB,aAAxB,CAEA,GAAMC,CAAAA,SAAS,CAAGD,WAAW,CAACE,cAAZ,CAA2B,CAC3CC,IAAI,CAAE,WADqC,CAA3B,CAAlB,CAIA,MAAO,IAAMC,CAAAA,WAAW,CAAG,QAAdA,CAAAA,WAAc,CAACC,SAAD,CAAuB,CAChD,MAAO,CACLF,IAAI,CAAE,cADD,CAELG,KAFK,gBAECC,KAFD,CAE6B,CAChCA,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,cAAV,CAAb,CAAyC,UAAM,CAC7C,MAAO,CACLC,MAAM,CAAE,KADH,CAELC,QAAQ,CAAEN,SAFL,CAAP,CAID,CALD,EAMAE,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,IAAV,CAAb,0FAA+B,iBAAOG,IAAP,yJACFX,CAAAA,SAAS,CAACY,OAAV,CACzBD,IAAI,CAACE,IADoB,CADE,QACvBC,YADuB,mBAKzBA,YALyB,yDAMpBA,YANoB,wDAA/B,gEASAR,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,OAAV,CAAb,2FAAkC,kBAAOG,IAAP,uMACAb,CAAAA,KAAK,CAACiB,GAAN,CAAUJ,IAAI,CAACE,IAAf,CADA,wCACxBG,IADwB,kBACxBA,IADwB,CAClBC,OADkB,kBAClBA,OADkB,CAG1BC,OAH0B,CAGhBF,IAAI,CACjBG,OADa,CACL,KADK,CACE,EADF,EAEbA,OAFa,CAEL,IAFK,CAEC,KAFD,EAGbA,OAHa,CAGL,IAHK,CAGC,KAHD,CAHgB,CAO1BT,QAP0B,0GASPQ,OATO,uDAY1BE,MAZ0B,CAYK,CACnCX,MAAM,CAAE,KAD2B,CAEnCC,QAAQ,CAARA,QAFmC,CAGnCW,UAAU,CAAE,GAAIC,CAAAA,GAAJ,CAAQ,IAAR,CAAcL,OAAO,CAACM,WAAtB,EAAmCC,QAHZ,CAZL,yBAiB1BxB,CAAAA,SAAS,CAACyB,OAAV,CAAkBd,IAAI,CAACE,IAAvB,CAA6BO,MAA7B,CAjB0B,0CAmBzBA,MAnByB,2DAAlC,kEAqBAd,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,IAAV,CAAb,2FAA+B,kBAAOG,IAAP,uLACGb,CAAAA,KAAK,CAACiB,GAAN,CAAUJ,IAAI,CAACE,IAAf,CADH,yCACrBG,IADqB,mBACrBA,IADqB,CACfC,OADe,mBACfA,OADe,CAGvBG,MAHuB,CAGQ,CACnCX,MAAM,CAAE,KAD2B,CAEnCC,QAAQ,CAAEM,IAFyB,CAGnCK,UAAU,CAAE,GAAIC,CAAAA,GAAJ,CAAQ,IAAR,CAAcL,OAAO,CAACM,WAAtB,EAAmCC,QAHZ,CAHR,wBAQvBxB,CAAAA,SAAS,CAACyB,OAAV,CAAkBd,IAAI,CAACE,IAAvB,CAA6BO,MAA7B,CARuB,yCAUtBA,MAVsB,0DAA/B,kEAYD,CAnDI,CAAP,CAqDD,CAtDM","sourcesContent":["import axios from 'axios';\nimport * as esbuild from 'esbuild-wasm';\nimport localforage from 'localforage';\n\nconst fileCache = localforage.createInstance({\n  name: 'filecache',\n});\n\nexport const fetchPlugin = (inputCode: string) => {\n  return {\n    name: 'fetch-plugin',\n    setup(build: esbuild.PluginBuild) {\n      build.onLoad({ filter: /(^index\\.js)/ }, () => {\n        return {\n          loader: 'jsx',\n          contents: inputCode,\n        };\n      });\n      build.onLoad({ filter: /.*/ }, async (args: any) => {\n        const cachedResult = await fileCache.getItem<esbuild.OnLoadResult>(\n          args.path\n        );\n\n        if (cachedResult) {\n          return cachedResult;\n        }\n      });\n      build.onLoad({ filter: /.css$/ }, async (args: any) => {\n        const { data, request } = await axios.get(args.path);\n\n        const escaped = data\n          .replace(/\\n/g, '')\n          .replace(/\"/g, '\\\\\"')\n          .replace(/'/g, \"\\\\'\");\n        const contents = `\n              const style = document.createElement('style');\n              style.innerText='${escaped}';\n              document.head.appendChild(style)`;\n\n        const result: esbuild.OnLoadResult = {\n          loader: 'jsx',\n          contents,\n          resolveDir: new URL('./', request.responseURL).pathname,\n        };\n        await fileCache.setItem(args.path, result);\n\n        return result;\n      });\n      build.onLoad({ filter: /.*/ }, async (args: any) => {\n        const { data, request } = await axios.get(args.path);\n\n        const result: esbuild.OnLoadResult = {\n          loader: 'jsx',\n          contents: data,\n          resolveDir: new URL('./', request.responseURL).pathname,\n        };\n        await fileCache.setItem(args.path, result);\n\n        return result;\n      });\n    },\n  };\n};\n"]},"metadata":{},"sourceType":"module"}